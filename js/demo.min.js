"use strict";$(function(){var g="/netdisk",d="/netdisk/files";var H={uploadFile:$(".btn-file-toolbar-primary[name=upload]"),addFolder:$(".btn-file-toolbar-secondary[name=add-folder]"),deleteFile:$(".btn-file-toolbar-secondary[name=delete]"),refresh:$(".btn-file-toolbar-primary[name=refresh]"),simulateUpload:$("#simulateUpload")},q=$("#fileTable"),z={upload:{el:$("#uploadModal"),file:$("#file")},addFolder:{el:$("#addFolderModal"),input:$("#new-folder"),save:$("#new-folder-save")},preview:{el:$("#previewModal"),image:$("#preview-image"),audio:$("#preview-audio"),video:$("#preview-video"),pdf:$("#preview-pdf")}};$('[data-toggle="tooltip"]').tooltip();var w={get:function A(J){if(typeof Storage!=="undefined"){var I=localStorage.getItem(J);if(!isNaN(parseInt(I))){I=parseInt(I)}return I}else{window.alert("Please use modern browser !")}},del:function h(I){if(typeof Storage!=="undefined"){return localStorage.removeItem(I)}else{window.alert("Please use modern browser !")}},store:function e(I,J){if(typeof Storage!=="undefined"){localStorage.setItem(I,J)}else{window.alert("Please use modern browser !")}},clean:function s(){if(typeof Storage!=="undefined"){var K=/^nd_$/;for(var I in window.localStorage){var J=window.localStorage.key(I);if(K.test(J)){window.localStorage.removeItem(J)}}}else{window.alert("Please use modern browser !")}}};var E={getFileListAjax:function p(){return $.getJSON("data/file/file-list")},getFileList:function v(){return JSON.parse(w.get("nd_file_list"))},setFileList:function F(I){return w.store("nd_file_list",JSON.stringify(I))}};var a={currentFolder:0,maxFileId:null,loadFileList:function D(N,M){q.find("a").off("click");q.bootstrapTable("destroy");q.bootstrapTable({data:N,columns:[{checkbox:true},{"class":"text-small",field:"file_name",title:"文件名",formatter:function J(P,Q){return'\n                            <a class="file-column '+Q.file_type+'"\n                                data-file-id="'+Q.file_id+'"\n                                data-parent-id="'+M+'"\n                            href="javascript:;">\n                                <i class="file-type"></i>'+P+'\n                            </a>\n                            <div class="file-action pull-right">\n                                <!--<a class="btn-for-file"><i class="fa fa-share"></i></a>-->\n                                <a href="'+d+Q.file_path+'" class="btn-for-file '+(Q.is_folder?"hidden":"")+'">\n                                    <i class="fa fa-download"></i>\n                                </a>\n                                <!--<a class="btn-for-file"><i class="fa fa-trash"></i></a>-->\n                            </div>\n                        '}},{"class":"text-small",field:"file_size",title:"大小",formatter:function J(P){return P!==null?m(P):P}},{"class":"text-small",field:"file_last_modified",title:"修改日期"}],onCheck:function I(){if(q.bootstrapTable("getSelections").length){H.deleteFile.removeClass("hidden")}},onUncheck:function L(){if(!q.bootstrapTable("getSelections").length){H.deleteFile.addClass("hidden")}},onCheckAll:function O(){if(q.bootstrapTable("getSelections").length){H.deleteFile.removeClass("hidden")}},onUncheckAll:function K(){if(!q.bootstrapTable("getSelections").length){H.deleteFile.addClass("hidden")}}});q.find("a.file-column.folder").on("click",function(){var P=a.find(E.getFileList(),parseInt($(this).attr("data-file-id")));var Q=a.currentFolder;a.currentFolder=parseInt($(this).attr("data-file-id"));r.add(P.node["file_name"],a.currentFolder,Q);a.loadFileList(P.node["content_inside"],Q);r.backToParent.show()});q.find("a.file-column.image").on("click",function(){var P=a.find(E.getFileList(),parseInt($(this).attr("data-file-id")));z.preview.image.attr("src",d+P.node["file_path"]);z.preview.image.addClass("display");z.preview.el.modal("show")});q.find("a.file-column.audio").on("click",function(){var P=a.find(E.getFileList(),parseInt($(this).attr("data-file-id")));z.preview.audio.attr("src",d+P.node["file_path"]);z.preview.audio.addClass("display");z.preview.el.modal("show")});q.find("a.file-column.video").on("click",function(){var P=a.find(E.getFileList(),parseInt($(this).attr("data-file-id")));z.preview.video.attr("src",d+P.node["file_path"]);z.preview.video.addClass("display");z.preview.el.modal("show")});q.find("a.file-column.pdf").on("click",function(){var P=a.find(E.getFileList(),parseInt($(this).attr("data-file-id")));z.preview.pdf.attr("src",g+"/vendor/pdfjs/web/viewer.html?file="+d+P.node["file_path"]);z.preview.pdf.addClass("display");z.preview.el.modal("show")})},find:function o(J,M){var I=[];if(M===0){return E.getFileList()}for(var L in J){if(!J.hasOwnProperty(L)){continue}I.push({parent:-1,index:L,node:J[L]})}while(I.length!==0){var O=I.pop();var K=O.node;if(K.file_id===M){return O}if(K.is_folder){for(var N in K.content_inside){if(!K.content_inside.hasOwnProperty(N)){continue}I.push({parent:K,index:N,node:K.content_inside[N]})}}}return null},add:function n(K,J){var I=E.getFileList();var L=void 0;if(K!==0){L=a.find(I,K);if(L===null){return}L.node["content_inside"].push(J)}else{I.push(J)}console.log(I);E.setFileList(I)},remove:function G(J){var I=E.getFileList();var L=a.find(I,J);if(L===null){return}var K=L.parent;if(L.parent===-1){I.splice(L.index,1)}else{K.content_inside.splice(L.index,1)}E.setFileList(I)},get:{file:function y(J,L,K){var I=void 0;switch(L){case 0:I="unknown";break;case 1:I="image";break;case 2:I="audio";break;case 3:I="video";break;case 4:I="pdf";break}a.maxFileId++;return{file_id:a.maxFileId,file_name:J,file_size:K,file_last_modified:new Date().format("yyyy-MM-dd hh:mm"),file_type:I,is_folder:false}},folder:function f(I){a.maxFileId++;return{file_id:a.maxFileId,file_name:I,file_size:null,file_last_modified:new Date().format("yyyy-MM-dd hh:mm"),file_type:"folder",is_folder:true,is_empty:true,content_inside:[]}}},refresh:function c(){r.reset();H.deleteFile.addClass("hidden");a.currentFolder=0;a.loadFileList(E.getFileList(),-1)}};var u={el:$(".alert.on-top"),dismiss:function x(){u.el.removeClass("display")},display:function t(I){u.el.find("p").text(I);u.el.addClass("display")}};u.el.find("close").on("click",function(){u.dismiss()});var r={el:$(".breadcrumb"),root:$(".breadcrumb .root"),add:function n(I,J,K){var L=$('<li class="node inside" data-file-id="'+J+'" data-parent-id="'+K+'"><a>'+I+"</a></li>");L.on("click",function(){var M=a.find(E.getFileList(),parseInt($(this).attr("data-file-id")));a.loadFileList(M.node["content_inside"],parseInt($(this).attr("data-file-id")));a.currentFolder=parseInt($(this).attr("data-file-id"));$(this).nextAll().remove()});r.el.append(L)},reset:function C(){r.backToParent.hide();r.el.find("li.node.inside").remove()},removeLast:function l(){r.el.find("li").last().remove()},backToParent:{el:$(".path-previous"),hide:function k(){return r.backToParent.el.removeClass("active")},show:function B(){return r.backToParent.el.addClass("active")},method:function b(K){var I={},J=void 0;if(K===0){I.parent_id=-1;J=E.getFileList();a.currentFolder=0}else{I=a.find(E.getFileList(),K);J=I.node["content_inside"]}a.loadFileList(J,I.parent_id);if(!a.currentFolder){r.backToParent.hide()}r.removeLast()}}};r.root.on("click",function(){a.refresh()});r.backToParent.el.on("click",function(){r.backToParent.method(parseInt(r.el.find("li.node.inside").last().attr("data-parent-id")))});z.addFolder.el.on("hidden.bs.modal",function(){$(this).find("input").val(null)});z.addFolder.input.on("keydown",function(I){if(I.keyCode===56&&I.keyCode===186&&I.keyCode===188&&I.keyCode===190&&I.keyCode===191&&I.keyCode===220&&I.keyCode===222&&I.key==="*"&&I.key===":"&&I.key==="<"&&I.key===">"&&I.key==="?"&&I.key==="/"&&I.key==="\\"&&I.key==="|"&&I.key==='"'){return false}}).on("input",function(){if(!this.value.length){z.addFolder.save.prop("disabled",true)}else{z.addFolder.save.prop("disabled",false)}});z.addFolder.save.on("click",function(){var I=/^(?!\.)[^\\\/:*?"<>|]{1,255}$/,J=z.addFolder.input.val();if(I.test(J)){var K=a.get.folder(J);a.add(a.currentFolder,K);z.addFolder.el.modal("hide");swal("创建成功","已成功创建文件夹","success").then(function(){if(!a.currentFolder){a.loadFileList(E.getFileList(),-1)}else{var L=a.find(E.getFileList(),a.currentFolder);a.loadFileList(L.node["content_inside"],a.currentFolder)}})}else{swal("创建失败","请检查名称是否符合规则","error")}});z.preview.el.on("hide.bs.modal",function(){$(this).find(".preview-media").each(function(){this.pause()});z.preview.pdf.attr("src",null)}).on("hidden.bs.modal",function(){$(this).find(".preview-el").attr("src",null).removeClass("display")});H.deleteFile.on("click",function(){var I=q.bootstrapTable("getSelections");swal({title:"删除确认",text:"确定删除选中文件吗？",icon:"warning",buttons:{cancel:"取消",confirm:"确认"},dangerMode:true}).then(function(J){if(J){for(let i in I){if(!I.hasOwnProperty(i)){continue}a.remove(I[i]["file_id"])}swal("删除成功","已删除指定的文件","success").then(function(){H.deleteFile.addClass("hidden");if(a.currentFolder===0){a.loadFileList(E.getFileList(),a.currentFolder)}else{var K=a.find(E.getFileList(),a.currentFolder);a.loadFileList(K.node["content_inside"],a.currentFolder)}})}})});H.refresh.on("click",function(){a.refresh()});H.simulateUpload.on("click",function(){if(z.upload.file[0].files.length){var J=z.upload.file[0].files[0];var I=J.type.substr(0,5);var K=void 0;if(J.type===""){K=0}else{if(I==="image"){K=1}else{if(I==="audio"){K=2}else{if(I==="video"){K=3}else{if(J.type==="application/pdf"){K=4}}}}}var L=a.get.file(J.name,K,J.size);a.add(a.currentFolder,L);swal("上传成功","已成功上传文件","success").then(function(){z.upload.el.modal("hide");z.upload.file.fileinput("reset");if(!a.currentFolder){a.loadFileList(E.getFileList(),-1)}else{var M=a.find(E.getFileList(),a.currentFolder);a.loadFileList(M.node["content_inside"],a.currentFolder)}})}else{swal("错误","未选择文件","error")}});$(document).ready(function(){E.getFileListAjax().done(function(I){if(j(I.status)){E.setFileList(I.data["lists"]);a.maxFileId=I.data["max_file_id"];w.store("nd_max_file_id",I.data["max_file_id"]);a.loadFileList(E.getFileList(),-1)}});z.upload.file.fileinput({language:"zh",uploadUrl:"somewhere-to-upload",maxFileSize:102400,maxFileCount:1,overwriteInitial:"false"})});function j(I){return I==="success"}function m(I){if(!I){return"0 B"}var J=1024,L=["B","KB","MB","GB","TB","PB","EB","ZB","YB"];var K=Math.floor(Math.log(I)/Math.log(J));return(I/Math.pow(J,K)).toPrecision(3)+" "+L[K]}});Date.prototype.format=function(c){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S+":this.getMilliseconds()};if(/(y+)/i.test(c)){c=c.replace(RegExp.$1,(""+this.getFullYear()).substr(4-RegExp.$1.length))}for(var a in b){if(new RegExp("("+a+")").test(c)){c=c.replace(RegExp.$1,RegExp.$1.length===1?b[a]:("00"+b[a]).substr((""+b[a]).length))}}return c};